<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MNB66Q9E3B"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-MNB66Q9E3B');
    </script>
    <title>Moon and Darkness Calendar</title>
    <style>
        :root {
            --bg-gradient-start: #0f2027;
            --text-color: #fff;
            --accent-color: #ffd700;
            --input-bg-color: rgba(255, 255, 255, 0.2);
            --calendar-bg-color: rgba(255, 255, 255, 0.1);
        }
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(to bottom, var(--bg-gradient-start), #203a43, #2c5364);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #app {
            width: 90%;
            max-width: 1200px;
            background-color: var(--calendar-bg-color);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }
        h1 {
            text-align: center;
            color: var(--accent-color);
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .controls-left, .controls-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input, button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            font-size: 1em;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        button {
            cursor: pointer;
            background-color: var(--accent-color);
            color: var(--bg-gradient-start);
            transition: all 0.3s ease;
            text-wrap: nowrap;
        }
        button:hover {
            background-color: var(--text-color);
            color: var(--bg-gradient-start);
        }
        #calendar-view {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            background-color: var(--calendar-bg-color);
            padding: 20px;
            border-radius: 10px;
        }
        .day-row {
            display: contents;
            cursor: pointer;
        }
        .day-left, .day-right {
            font-weight: bold;
            background-color: var(--input-bg-color);
            padding: 6px;
            border-radius: 5px;
            display: flex;
            min-width: 80px;
            justify-content: space-between;
            align-items: center;
            flex-direction: row;
        }
        .day-right {
            justify-content: center;
        }
        .day-of-week {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .weekend-night { background-color: rgba(0, 255, 0, 0.1) !important; }
        .bars-container {
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
            gap: 4px;
        }
        .bar {
            display: flex;
            height: 22px;
            overflow: hidden;
        }
        .darkness-segment, .moon-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .darkness-segment[data-level="astronomicalNight"] { background-color: rgba(0, 0, 51, 0.9); }
        .darkness-segment[data-level="astronomicalTwilight"] { background-color: rgba(0, 0, 102, 0.8); }
        .darkness-segment[data-level="nauticalTwilight"] { background-color: rgba(0, 102, 204, 0.7); }
        .darkness-segment[data-level="civilTwilight"] { background-color: rgba(51, 153, 255, 0.6); }
        .darkness-segment[data-level="day"] { background-color: rgba(255, 255, 153, 0.5); }
        .hour-labels-row { display: contents; }
        .hour-labels-container {
            position: relative;
            left: -6px; /* account for the font-size (half the size should mostly center it) */
            margin-top: 5px;
            height: 30px;
            top: 12px;
        }
        .hour-label {
            position: absolute;
            font-size: 12px; /* Hardcode font-size for alignment */
            color: rgba(255, 255, 255, 0.7);
            transform: translateX(-50%) rotate(-90deg);
            transform-origin: top center;
            white-space: nowrap;
        }
        .inline-indicator {
            font-size: 0.7em;
            margin: 4px;
            opacity: 0.6;
            overflow: hidden;
            display: none;
        }
        .date-info, .moon-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .moon-info {
            font-size: 0.6em;
        }
        .moon-icon {
            font-size: 18px;
        }
        .day-of-week {
            font-size: 0.8em;
            opacity: 0.8;
        }
        @media (max-width: 768px) {
            #app {
                width: 95%;
                padding: 15px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .controls-left, .controls-right {
                min-width: 40px;
                flex-wrap: wrap;
                justify-content: space-between;
            }
            input, button {
                flex: 1 1 auto;
            }
            #calendar-view {
                grid-template-columns: auto 1fr;
                padding: 10px;
            }
            .hour-labels-row {
                display: none;
            }
            .day-right {
                display: none;
            }
            .day-left {
                min-width: 0;
            }
        }
        @media (max-width: 480px) {
            h1 {
                font-size: 2em;
            }
            input, button {
                width: 100%;
            }
        }
        .show-inline-times .inline-indicator,
        .day-row:hover .inline-indicator {
            display: inline;
        }

        #show-inline-times {
            margin-right: 5px;
        }

        .hour-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: rgba(255, 255, 255, 0.2);
            pointer-events: none;
            display: none;
        }

        .show-hour-lines .hour-line,
        .day-row:hover .hour-line {
            display: block;
        }

        .day-detail {
            display: none;
            background-color: var(--calendar-bg-color);
            padding: 15px;
            border-radius: 5px;
            grid-column: 1 / -1;
        }

        .day-detail.active {
            display: block;
        }

        .day-detail h3 {
            margin-top: 0;
            color: var(--accent-color);
        }

        .day-detail p {
            margin: 5px 0;
        }

        .day-detail .close-button {
            float: right;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2em;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1>Moon and Darkness Calendar</h1>
        </header>
        <main>
            <div class="controls">
                <form id="location-form" class="controls-left">
                    <label for="location">Location:</label>
                    <input type="text" id="location" placeholder="Enter city name" aria-label="Enter city name" autocomplete="off">
                    <button type="submit">Search</button>
                    <button type="button" id="use-location">Use My Location</button>
                </form>
                <form id="date-form" class="controls-right">
                    <label for="start-date">Start Date:</label>
                    <input type="date" id="start-date" aria-label="Start date">
                    <label for="num-days">Days:</label>
                    <input type="number" id="num-days" value="30" min="1" max="365" placeholder="Days" aria-label="Days">
                    <button type="submit">Update</button>
                </form>
                <label for="show-inline-times">
                    <input type="checkbox" id="show-inline-times"> Show inline times
                </label>
                <label for="show-hour-lines">
                    <input type="checkbox" id="show-hour-lines"> Show hour lines
                </label>
            </div>
            <section id="calendar-view" aria-live="polite">
                <h2>Please enter a location or click the "Use My Location" button.</h2>
            </section>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/suncalc3@2.0.5/suncalc.min.js"></script>
    <script type="module">
        const $ = (selector) => document.querySelector(selector);
        const getUrlParams = () => new URLSearchParams(window.location.search);
        const setUrlParams = (params) => window.history.replaceState({}, '', `${window.location.pathname}?${params}`);

        const formatDate = (date, format) => {
            const options = {
                'MMM D': { month: 'short', day: 'numeric' },
                'ddd': { weekday: 'short' },
                'YYYY-MM-DD': { year: 'numeric', month: '2-digit', day: '2-digit' },
                'HH:mm:ss': { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false },
                'HH:mm': { hour: '2-digit', minute: '2-digit', hour12: false }
            };
            if (!date) return '--';
            return new Intl.DateTimeFormat(navigator.language, options[format]).format(date);
        };

        const formatDuration = (start, end) => {
            const durationMs = end - start;
            const hours = Math.floor(durationMs / (1000 * 60 * 60));
            const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}:${minutes.toString().padStart(2, '0')}h`;
        };

        const addDays = (date, days) => {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        };

        const getRowData = (startDate, lat, lon) => {
            const endDate = addDays(startDate, 1);

            const isIn = (time) => {
                return time >= startDate && time < endDate;;
            }

            const moonIlluminationLeft = SunCalc.getMoonIllumination(startDate);
            const moonIlluminationRight = SunCalc.getMoonIllumination(endDate);
            const moonTimesLeft = SunCalc.getMoonTimes(startDate, lat, lon);
            const moonTimesRight = SunCalc.getMoonTimes(endDate, lat, lon);
            const sunTimesLeft = SunCalc.getSunTimes(startDate, lat, lon);
            const sunTimesRight = SunCalc.getSunTimes(endDate, lat, lon);

            const moonRiseTime = isIn(moonTimesLeft.rise, startDate, endDate) ? moonTimesLeft.rise : moonTimesRight.rise || null;
            const moonSetTime = isIn(moonTimesLeft.set) ? moonTimesLeft.set : moonTimesRight.set || null;
            const moonHighestTime = isIn(moonTimesLeft.highest) ? moonTimesLeft.highest : moonTimesRight.highest;
            const moonPositionAtHighest = SunCalc.getMoonPosition(moonHighestTime, lat, lon);
            const moonHighestDegrees = moonPositionAtHighest.altitudeDegrees;  // fixme: not needed maybe?
            const moonPhaseName = isIn(moonTimesLeft.highest) ? moonIlluminationLeft.phase.name : moonIlluminationRight.phase.name;
            const moonPhaseEmoji = isIn(moonTimesLeft.highest) ? moonIlluminationLeft.phase.emoji : moonIlluminationRight.phase.emoji;
            const moonPhaseFraction = isIn(moonTimesLeft.highest) ? moonIlluminationLeft.fraction : moonIlluminationRight.fraction;
            const sunRiseTime = isIn(sunTimesLeft.sunriseEnd.value) ? sunTimesLeft.sunriseEnd.value : sunTimesRight.sunriseEnd.value;
            const sunSetTime = isIn(sunTimesLeft.sunsetStart.value) ? sunTimesLeft.sunsetStart.value : sunTimesRight.sunsetStart.value;
            const sunDawnTime = isIn(sunTimesLeft.civilDawn.value) ? sunTimesLeft.civilDawn.value : sunTimesRight.civilDawn.value;
            const sunDuskTime = isIn(sunTimesLeft.civilDusk.value) ? sunTimesLeft.civilDusk.value : sunTimesRight.civilDusk.value;
            const sunNightTime = isIn(sunTimesLeft.astronomicalDusk.value) ? sunTimesLeft.astronomicalDusk.value : sunTimesRight.astronomicalDusk.value;
            const sunNightEndTime = isIn(sunTimesLeft.astronomicalDawn.value) ? sunTimesLeft.astronomicalDawn.value : sunTimesRight.astronomicalDawn.value;

            const getSunDarknessLevel = (time) => {
                const sunPosition = SunCalc.getPosition(time, lat, lon);
                const altitude = sunPosition.altitude * (180 / Math.PI);
                if (altitude < -18) return 'astronomicalNight';
                if (altitude < -12) return 'astronomicalTwilight';
                if (altitude < -6) return 'nauticalTwilight';
                if (altitude < 0) return 'civilTwilight';
                return 'day';
            };

            const getMoonIsVisible = (time) => {
                const moonPosition = SunCalc.getMoonPosition(time, lat, lon);
                const altitude = moonPosition.altitude * (180 / Math.PI);
                if (altitude < 0) return false;
                return true
            }

            const rowData = {
                startDate,
                endDate,
                moonRiseTime,
                moonSetTime,
                moonHighestTime,
                moonHighestDegrees,
                moonPhaseName,
                moonPhaseEmoji,
                moonPhaseFraction,
                sunRiseTime,
                sunSetTime,
                sunDawnTime,
                sunDuskTime,
                sunNightTime,
                sunNightEndTime,
                getSunDarknessLevel,
                getMoonIsVisible,
            }
            return rowData;
        }

        const getMoonSegmentColor = (isVisible, illumination) => {
            const c = Math.round(64 + (255 - 64) * illumination);
            return isVisible ? `rgba(${c}, ${c}, ${c}, 1)` : 'rgba(0, 0, 32, 0.8)';
        };

        const getWidth = (start, end) => `${(end - start) / (24 * 60 * 60 * 1000) * 100}%`;

        const createDarknessSegment = (start, end, level, rowData) => {
            const segment = document.createElement('div');
            segment.className = 'darkness-segment';
            segment.style.width = getWidth(start, end);
            segment.dataset.level = level;
            if (level === 'astronomicalNight') {
                const startElement = document.createElement('div');
                startElement.className = 'inline-indicator';
                if (start > rowData.startDate) {
                    startElement.textContent = formatDate(rowData.sunNightTime, 'HH:mm');
                }
                segment.appendChild(startElement);

                const endElement = document.createElement('div');
                endElement.className = 'inline-indicator';
                if (end < rowData.endDate) {
                    endElement.textContent = formatDate(rowData.sunNightEndTime, 'HH:mm');
                }
                segment.appendChild(endElement);
            }
            return segment;
        };

        const createMoonSegment = (start, end, isVisible, rowData) => {
            const segment = document.createElement('div');
            segment.className = 'moon-segment';
            segment.style.width = getWidth(start, end);
            segment.style.backgroundColor = getMoonSegmentColor(isVisible, rowData.moonPhaseFraction);

            if (!isVisible) {
                const startElement = document.createElement('div');
                startElement.className = 'inline-indicator';
                if (start > rowData.startDate) {
                    startElement.textContent = formatDate(rowData.moonSetTime, 'HH:mm');
                }
                segment.appendChild(startElement);

                const endElement = document.createElement('div');
                endElement.className = 'inline-indicator';
                if (end < rowData.endDate) {
                    endElement.textContent = formatDate(rowData.moonRiseTime, 'HH:mm');
                }
                segment.appendChild(endElement);
            }

            return segment;
        };

        const createHourLabels = () => {
            const hourLabelsRow = document.createElement('div');
            hourLabelsRow.className = 'hour-labels-row';

            const emptyLeft = document.createElement('div');
            emptyLeft.className = 'day-left';
            emptyLeft.style.visibility = 'hidden';
            hourLabelsRow.appendChild(emptyLeft);

            const labelsContainer = document.createElement('div');
            labelsContainer.className = 'hour-labels-container';

            for (let hour = 12; hour <= 36; hour++) {
                const label = document.createElement('div');
                label.className = 'hour-label';
                label.textContent = `${(hour % 24).toString().padStart(2, '0')}:00`;
                label.style.left = `${((hour - 12) / 24) * 100}%`;
                labelsContainer.appendChild(label);
            }

            hourLabelsRow.appendChild(labelsContainer);

            const emptyRight = document.createElement('div');
            emptyRight.className = 'day-right';
            emptyRight.style.visibility = 'hidden';
            hourLabelsRow.appendChild(emptyRight);

            return hourLabelsRow;
        };

        const createDarknessBar = (rowData) => {
            const bar = document.createElement('div');
            bar.className = 'bar darkness-bar';

            let currentTime = new Date(rowData.startDate);
            let currentState = rowData.getSunDarknessLevel(currentTime);
            let segmentStart = new Date(currentTime);

            while (currentTime < rowData.endDate) {
                const newState = rowData.getSunDarknessLevel(currentTime);

                if (newState !== currentState) {
                    bar.appendChild(createDarknessSegment(segmentStart, currentTime, currentState, rowData));
                    segmentStart = new Date(currentTime);
                    currentState = newState;
                }
                currentTime.setMinutes(currentTime.getMinutes() + 5);
            }

            bar.appendChild(createDarknessSegment(segmentStart, rowData.endDate, currentState, rowData));

            return bar;
        };

        const createMoonBar = (rowData) => {
            const bar = document.createElement('div');
            bar.className = 'bar moon-bar';

            let currentTime = new Date(rowData.startDate);
            let currentState = rowData.getMoonIsVisible(currentTime);
            let segmentStart = new Date(currentTime);

            while (currentTime < rowData.endDate) {
                const newState = rowData.getMoonIsVisible(currentTime);

                if (newState !== currentState) {
                    bar.appendChild(createMoonSegment(segmentStart, currentTime, currentState, rowData));
                    segmentStart = new Date(currentTime);
                    currentState = newState;
                }
                currentTime.setMinutes(currentTime.getMinutes() + 5);
            }

            bar.appendChild(createMoonSegment(segmentStart, rowData.endDate, currentState, rowData));

            return bar;
        };

        const createDetailSection = (rowData) => {
            const detailSection = document.createElement('div');
            detailSection.className = 'day-detail';
            
            const closeButton = document.createElement('button');
            closeButton.className = 'close-button';
            closeButton.innerHTML = '&times;';
            closeButton.addEventListener('click', (e) => {
                e.stopPropagation();
                detailSection.classList.remove('active');
            });

            detailSection.innerHTML = `
                <h3>Night Details ${formatDate(rowData.startDate, 'YYYY-MM-DD')} - ${formatDate(rowData.endDate, 'YYYY-MM-DD')}</h3>
                
                <h4>Darkness Information</h4>
                <p>Civil Darkness: ${formatDate(rowData.sunSetTime, 'HH:mm:ss')} - ${formatDate(rowData.sunRiseTime, 'HH:mm:ss')} = ${formatDuration(rowData.sunSetTime, rowData.sunRiseTime)}</p>
                <p>Nautical Darkness: ${formatDate(rowData.sunDuskTime, 'HH:mm:ss')} - ${formatDate(rowData.sunDawnTime, 'HH:mm:ss')} = ${formatDuration(rowData.sunDuskTime, rowData.sunDawnTime)}</p>
                <p>Astronomical Darkness: ${formatDate(rowData.sunNightTime, 'HH:mm:ss')} - ${formatDate(rowData.sunNightEndTime, 'HH:mm:ss')} = ${formatDuration(rowData.sunNightTime, rowData.sunNightEndTime)}</p>
                
                <h4>Moon Information</h4>
                <p>Moon Phase: ${rowData.moonPhaseName} (${(rowData.moonPhaseFraction * 100).toFixed(1)}% illuminated)</p>
                <p>Moonrise: ${rowData.moonRiseTime ? formatDate(rowData.moonRiseTime, 'HH:mm:ss') : 'N/A'}</p>
                <p>Moonset: ${rowData.moonSetTime ? formatDate(rowData.moonSetTime, 'HH:mm:ss') : 'N/A'}</p>
                <p>Moon Highest: ${formatDate(rowData.moonHighestTime, 'HH:mm:ss')} (${rowData.moonHighestDegrees.toFixed(1)}°)</p>
            `;

            detailSection.insertBefore(closeButton, detailSection.firstChild);
            return detailSection;
        };

        const createDayRow = (startDate, lat, lon) => {
            const rowData = getRowData(startDate, lat, lon);

            const dayRow = document.createElement('div');
            dayRow.className = 'day-row';

            const dayLeft = document.createElement('div');
            dayLeft.className = 'day-left';
            if ([5, 6].includes(rowData.startDate.getDay())) dayLeft.classList.add('weekend-night');
            
            dayLeft.innerHTML = `
                <div class="date-info">
                    <span>${formatDate(rowData.startDate, 'MMM D')}</span>
                    <span class="day-of-week">${formatDate(rowData.startDate, 'ddd')}</span>
                </div>
                <div class="moon-info">
                    <span class="moon-icon">${rowData.moonPhaseEmoji}</span>
                    <span>${(rowData.moonPhaseFraction * 100).toFixed(0)}%</span>
                </div>
            `;
            dayRow.appendChild(dayLeft);

            const barsContainer = document.createElement('div');
            barsContainer.className = 'bars-container';

            barsContainer.appendChild(createDarknessBar(rowData));
            barsContainer.appendChild(createMoonBar(rowData));
            for (let hour = 0; hour <= 24; hour++) {
                const line = document.createElement('div');
                line.className = 'hour-line';
                line.style.left = `${(hour / 24) * 100}%`;
                barsContainer.appendChild(line);
            }
            dayRow.appendChild(barsContainer);

            const dayRight = document.createElement('div');
            dayRight.className = 'day-right';
            if ([6, 0].includes(rowData.endDate.getDay())) dayRight.classList.add('weekend-night');
            dayRight.innerHTML = `
                <div class="date-info">
                    <span>${formatDate(rowData.endDate, 'MMM D')}</span>
                    <span class="day-of-week">${formatDate(rowData.endDate, 'ddd')}</span>
                </div>
            `;
            dayRow.appendChild(dayRight);

            const detailSection = createDetailSection(rowData);
            dayRow.appendChild(detailSection);

            dayRow.addEventListener('click', () => {
                detailSection.classList.toggle('active');
            });

            return dayRow;
        };

        const generateCalendar = async () => {
            const params = getUrlParams();
            const lat = parseFloat(params.get('lat'));
            const lon = parseFloat(params.get('lon'));
            const startDate = $('#start-date').value ? new Date($('#start-date').value) : new Date();
            const numDays = parseInt($('#num-days').value, 10);

            if (!lat || !lon || isNaN(startDate.getTime()) || isNaN(numDays) || numDays < 1) {
                alert('Please ensure location is set and all fields are filled correctly.');
                return;
            }

            const calendarView = $('#calendar-view');
            calendarView.innerHTML = '';
            calendarView.appendChild(createHourLabels());

            const start = new Date(startDate);
            start.setHours(12, 0, 0, 0);

            try {
                for (let day = 0; day < numDays; day++) {
                    const date = addDays(start, day);
                    const dayRow = createDayRow(date, lat, lon);
                    calendarView.appendChild(dayRow);
                }

                calendarView.appendChild(createHourLabels());
            } catch (error) {
                console.error('Error generating calendar:', error);
                alert('An error occurred while generating the calendar. Please try again.');
            }
        };

        const searchLocation = async () => {
            const location = $('#location').value;
            if (!location) {
                alert('Please enter a location.');
                return;
            }

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.length > 0) {
                    const { lat, lon } = data[0];
                    setUrlParams(new URLSearchParams({ lat, lon }));
                    await generateCalendar();
                } else {
                    alert('Location not found.');
                }
            } catch (error) {
                console.error('Error searching location:', error);
                alert('An error occurred while searching for the location. Please try again.');
            }
        };

        const useMyLocation = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    setUrlParams(new URLSearchParams({ lat: latitude, lon: longitude }));
                    generateCalendar();
                }, (error) => {
                    console.error('Error getting geolocation:', error);
                    alert('Unable to get your location. Please try entering a location manually.');
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        };

        const toggleInlineTimes = () => {
            document.body.classList.toggle('show-inline-times', $('#show-inline-times').checked);
        };

        const toggleHourLines = () => {
            document.body.classList.toggle('show-hour-lines', $('#show-hour-lines').checked);
        };

        document.addEventListener('DOMContentLoaded', () => {
            $('#start-date').value = new Date().toISOString().split('T')[0];
            $('#use-location').addEventListener('click', useMyLocation);
            $('#date-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await generateCalendar();
            });
            $('#location-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await searchLocation();
            });
            $('#show-inline-times').addEventListener('change', toggleInlineTimes);
            $('#show-hour-lines').addEventListener('change', toggleHourLines);

            const params = getUrlParams();
            if (params.get('lat') && params.get('lon')) {
                generateCalendar();
            }
        });
    </script>
</body>
</html>
