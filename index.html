<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MNB66Q9E3B"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-MNB66Q9E3B');
    </script>
    <title>Moon and Darkness Calendar</title>
    <style>
        /* Global Styles */
        :root {
            --bg-gradient-start: #0f2027;
            --text-color: #fff;
            --accent-color: #ffd700;
            --input-bg-color: rgba(255, 255, 255, 0.2);
            --calendar-bg-color: rgba(255, 255, 255, 0.1);
        }
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(to bottom, var(--bg-gradient-start), #203a43, #2c5364);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #app {
            width: 90%;
            max-width: 1200px;
            background-color: var(--calendar-bg-color);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }
        h1 {
            text-align: center;
            color: var(--accent-color);
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Controls Section Styles */
        .controls {
            background-color: var(--calendar-bg-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .controls-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .controls-row:last-child {
            margin-bottom: 0;
        }
        .location-row {
            flex-wrap: nowrap;
        }
        .location-search {
            position: relative;
            flex-grow: 1;
            min-width: 260px;
        }
        .or-separator {
            color: var(--text-color);
            padding: 0 20px 0 20px;
        }
        label {
            text-wrap: nowrap;
        }
        input, button {
            box-sizing: border-box;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            font-size: 1em;
        }
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
        }
        button {
            cursor: pointer;
            background-color: var(--accent-color);
            color: var(--bg-gradient-start);
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        button:hover {
            background-color: var(--text-color);
            color: var(--bg-gradient-start);
        }
        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--bg-gradient-start);
            border: 1px solid var(--accent-color);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .dropdown-item {
            padding: 5px 10px;
            cursor: pointer;
            color: var(--text-color);
        }
        .dropdown-item:hover {
            background-color: var(--accent-color);
            color: var(--bg-gradient-start);
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Calendar Styles */
        #calendar-view {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            background-color: var(--calendar-bg-color);
            padding: 20px;
            border-radius: 10px;
        }
        .day-row {
            display: contents;
            cursor: pointer;
        }
        .day-left, .day-right {
            font-weight: bold;
            background-color: var(--input-bg-color);
            padding: 6px;
            border-radius: 5px;
            display: flex;
            min-width: 80px;
            justify-content: space-between;
            align-items: center;
            flex-direction: row;
        }
        .day-right {
            justify-content: center;
        }
        .day-of-week {
            font-size: 0.8em;
            opacity: 0.8;
        }
        .weekend-night { background-color: rgba(0, 255, 0, 0.1) !important; }
        .bars-container {
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
            gap: 4px;
        }
        .bar {
            display: flex;
            height: 22px;
            overflow: hidden;
        }
        .darkness-segment, .moon-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .darkness-segment[data-level="astronomicalNight"] { background-color: rgba(0, 0, 51, 0.9); }
        .darkness-segment[data-level="astronomicalTwilight"] { background-color: rgba(0, 0, 102, 0.8); }
        .darkness-segment[data-level="nauticalTwilight"] { background-color: rgba(0, 102, 204, 0.7); }
        .darkness-segment[data-level="civilTwilight"] { background-color: rgba(51, 153, 255, 0.6); }
        .darkness-segment[data-level="day"] { background-color: rgba(255, 255, 153, 0.5); }
        .hour-labels-row { display: contents; }
        .hour-labels-container {
            position: relative;
            left: -6px;
            margin-top: 5px;
            height: 30px;
            top: 12px;
        }
        .hour-label {
            position: absolute;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            transform: translateX(-50%) rotate(-90deg);
            transform-origin: top center;
            white-space: nowrap;
        }
        .inline-indicator {
            font-size: 0.7em;
            margin: 4px;
            opacity: 0.6;
            overflow: hidden;
            display: none;
        }
        .date-info, .moon-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .moon-info {
            font-size: 0.6em;
        }
        .moon-icon {
            font-size: 18px;
        }
        .show-inline-times .inline-indicator,
        .day-row:hover .inline-indicator {
            display: inline;
        }
        .hour-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: rgba(255, 255, 255, 0.2);
            pointer-events: none;
            display: none;
        }
        .show-hour-lines .hour-line,
        .day-row:hover .hour-line {
            display: block;
        }
        .day-detail {
            display: none;
            background-color: var(--calendar-bg-color);
            padding: 15px;
            border-radius: 5px;
            grid-column: 1 / -1;
        }
        .day-detail.active {
            display: block;
        }
        .day-detail h3, .day-detail h4 {
            color: var(--accent-color);
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        .detail-table th, .detail-table td {
            padding: 5px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            text-align: left;
        }
        .detail-table th {
            background-color: rgba(255, 215, 0, 0.1);
        }
        .overlap-bar {
            height: 4px;
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            z-index: 2;
        }
        .overlap-segment {
            position: absolute;
            height: 100%;
            background-color: rgba(0, 255, 0, 0.3);
        }

        /* Help Details Styles */
        .help-details {
            margin-top: 30px;
            background-color: var(--calendar-bg-color);
            padding: 20px;
            border-radius: 10px;
        }
        .help-details h2 {
            color: var(--accent-color);
            margin-bottom: 15px;
        }
        .help-details h3 {
            color: var(--accent-color);
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .help-details p, .help-details ul, .help-details ol {
            margin-top: 10px;
            margin-left: 20px;
        }
        .help-details li {
            margin-bottom: 5px;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            #app {
                width: 95%;
                padding: 15px;
            }
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            .or-separator {
                display: none;
            }
            .location-row {
                flex-wrap: wrap;
            }
            #calendar-view {
                grid-template-columns: auto 1fr;
                padding: 10px;
            }
            .hour-labels-row {
                display: none;
            }
            .day-right {
                display: none;
            }
            .day-left {
                min-width: 0;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1>Moon and Darkness Calendar</h1>
        </header>
        <main>
            <div class="controls">
                <div class="controls-row location-row">
                    <button type="button" id="use-location">Use My Location</button>
                    <span class="or-separator">or</span>
                    <div class="location-search">
                        <input type="text" id="location" placeholder="Search location" aria-label="Search location" autocomplete="off">
                        <div id="location-dropdown" class="dropdown"></div>
                    </div>
                    <span class="or-separator">or</span>
                    <input type="number" id="latitude" step="any" placeholder="Latitude" aria-label="Latitude">
                    <input type="number" id="longitude" step="any" placeholder="Longitude" aria-label="Longitude">
                    <button type="button" id="set-coordinates">Go</button>
                </div>
                <div class="controls-row options-row">
                    <input type="date" id="start-date" aria-label="Start date">
                    <input type="number" id="num-days" value="30" min="1" max="365" placeholder="Days" aria-label="Number of days">
                    <label for="show-inline-times">
                        <input type="checkbox" id="show-inline-times"> Show inline times
                    </label>
                    <label for="show-hour-lines">
                        <input type="checkbox" id="show-hour-lines"> Show hour lines
                    </label>
                </div>
            </div>
            <section id="calendar-view" aria-live="polite">
                <h2>Please enter a location or click the "Use My Location" button.</h2>
            </section>
            <section id="help-details" class="help-details">
                <h2>Help and Details</h2>
                
                <h3>About</h3>
                <p>This Moon and Darkness Calendar is designed to help astronomers, astrophotographers, and night sky enthusiasts plan their observations. It provides a visual representation of darkness levels and moon phases, helping users identify optimal times for various types of night sky activities.</p>

                <h3>Using the Calendar</h3>
                <ol>
                    <li>Enter a location or use your current location.</li>
                    <li>Set a start date and number of days to display.</li>
                    <li>Hover over a day row to see hour-lines and inline times.</li>
                    <li>Click on a day row to see detailed information for that night.</li>
                    <li>Use the "Show inline times" option to display key times directly on the bars.</li>
                    <li>Use the "Show hour lines" option to display vertical hour markers.</li>
                </ol>

                <h3>Darkness Levels</h3>
                <p>The darkness levels are calculated using the sun's altitude above the horizon.</p>
                <ul>
                    <li><strong>Day:</strong> Sun's altitude > 0Â°. Full daylight.</li>
                    <li><strong>Civil Twilight:</strong> Sun's altitude between 0Â° and -6Â°. There's enough light for objects to be clearly distinguishable. Brightest stars become visible.</li>
                    <li><strong>Nautical Twilight:</strong> Sun's altitude between -6Â° and -12Â°. The horizon is no longer visible. Many stars used for celestial navigation are visible.</li>
                    <li><strong>Astronomical Twilight:</strong> Sun's altitude between -12Â° and -18Â°. The sky is dark enough for most astronomical observations, but some twilight still interferes with more sensitive observations.</li>
                    <li><strong>Astronomical Night:</strong> Sun's altitude < -18Â°. The darkest part of the night. Ideal for deep-sky observations and astrophotography.</li>
                </ul>
                <p>These calculations take into account atmospheric refraction, which causes the sun to appear slightly higher than it actually is.</p>

                <h3>Moon Information</h3>
                <p>The moon information includes several key details:</p>
                <ul>
                    <li><strong>Moon Phase:</strong> Represented as a a percentage of illumination. This directly affects the moon's brightness.</li>
                    <li><strong>Moonrise and Moonset:</strong> Times when the moon rises and sets, including azimuth angles and compass directions.</li>
                    <li><strong>Moon Altitude and Azimuth:</strong> The moon's height above the horizon and its direction in degrees from north.</li>
                    <li><strong>Moon Distance:</strong> The distance from Earth to the moon, with a percentage difference from the average distance of 384,400 km.</li>
                    <li><strong>Moon Parallactic Angle:</strong> The angle between the zenith and the pole of the ecliptic, as seen from the moon.</li>
                    <li><strong>Moon Illumination Angle:</strong> The angle of the moon's illumination.</li>
                </ul>
                <p>The visual representation in this calendar uses a grayscale gradient to indicate moon brightness, with darker shades representing a less bright moon and lighter shades a brighter moon. The moon is considered "invisible" when it's below the horizon, which is calculated based on the moon's altitude being negative.</p>
                <p>Note: Actual visibility can be affected by local conditions such as weather, light pollution, and the observer's dark adaptation, which are not accounted for in these calculations.</p>

                <h3>Overlap Bar</h3>
                <p>The green overlap bar indicates periods when both astronomical darkness and moon invisibility occur simultaneously. These are optimal times for deep-sky observation.</p>

                <h3>Weekend Nights</h3>
                <p>Weekend nights (Friday and Saturday) are highlighted with a slight green tint for easy identification of potentially more convenient observation times.</p>

                <h3>Feedback</h3>
                <p>If you have any suggestions, feature requests, or encounter any issues, please don't hesitate to reach out. You can contact me via astro@dersphere.de</p>

                <h3>Changelog</h3>
                <ul>
                    <li><strong>Version 2.0</strong> (24.20.2024): Rewrite. Added inline-times, hour-lines, overlap-bar, and replace tooltips with a daily detail section.</li>
                    <li><strong>Version 1.2</strong> (20.10.2024): Added gradient for moon illumination.</li>
                    <li><strong>Version 1.1</strong> (19.10.2024): Added tooltip with times for darkness and moon visibility.</li>
                    <li><strong>Version 1.0</strong> (19.10.2024): Initial release with basic darkness and moon phase calendar functionality.</li>
                </ul>
            </section>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/suncalc3@2.0.5/suncalc.min.js"></script>
    <script type="module">
        const $ = (selector) => document.querySelector(selector);
        const getUrlParams = () => new URLSearchParams(window.location.search);
        const setUrlParams = (params) => window.history.replaceState({}, '', `${window.location.pathname}?${params}`);

        const formatDate = (date, format) => {
            const options = {
                'MMM D': { month: 'short', day: 'numeric' },
                'ddd': { weekday: 'short' },
                'YYYY-MM-DD': { year: 'numeric', month: '2-digit', day: '2-digit' },
                'HH:mm:ss': { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false },
                'HH:mm': { hour: '2-digit', minute: '2-digit', hour12: false }
            };
            if (!date) return '--';
            return new Intl.DateTimeFormat(navigator.language, options[format]).format(date);
        };

        const formatDuration = (start, end) => {
            const durationMs = end - start;
            const hours = Math.floor(durationMs / (1000 * 60 * 60));
            const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}:${minutes.toString().padStart(2, '0')}h`;
        };

        const addDays = (date, days) => {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        };

        const getRowData = (startDate, lat, lon) => {
            const averageMoonDistance = 384400; // in km
            const endDate = addDays(startDate, 1);

            const isIn = (time) => {
                return time >= startDate && time < endDate;
            }

            const getMoonPhaseEmoji = (phaseValue) => {
                if (phaseValue < 0.03) {
                    return 'ðŸŒ‘'; // New Moon
                } else if (phaseValue < 0.21) {
                    return 'ðŸŒ’'; // Waxing Crescent
                } else if (phaseValue < 0.28) {
                    return 'ðŸŒ“'; // First Quarter
                } else if (phaseValue < 0.46) {
                    return 'ðŸŒ”'; // Waxing Gibbous
                } else if (phaseValue < 0.53) {
                    return 'ðŸŒ•'; // Full Moon
                } else if (phaseValue < 0.71) {
                    return 'ðŸŒ–'; // Waning Gibbous
                } else if (phaseValue < 0.78) {
                    return 'ðŸŒ—'; // Last Quarter
                } else if (phaseValue < 0.96) {
                    return 'ðŸŒ˜'; // Waning Crescent
                } else {
                    return 'ðŸŒ‘'; // Default to New Moon
                }
            };


            const moonTimesLeft = SunCalc.getMoonTimes(startDate, lat, lon);
            const moonTimesRight = SunCalc.getMoonTimes(endDate, lat, lon);
            const sunTimesLeft = SunCalc.getSunTimes(startDate, lat, lon);
            const sunTimesRight = SunCalc.getSunTimes(endDate, lat, lon);

            const moonRiseTime = isIn(moonTimesLeft.rise) ? moonTimesLeft.rise : moonTimesRight.rise || null;
            const moonRiseData = SunCalc.getMoonData(moonRiseTime, lat, lon);
            const moonSetTime = isIn(moonTimesLeft.set) ? moonTimesLeft.set : moonTimesRight.set || null;
            const moonSetData = SunCalc.getMoonData(moonSetTime, lat, lon);
            let moonHighestTime = null;
            if (moonRiseTime && moonSetTime) {
                moonHighestTime = new Date((moonRiseTime.getTime() + moonSetTime.getTime()) / 2);
                if (moonSetTime < moonRiseTime ) {
                    moonHighestTime = new Date(moonHighestTime.setHours(moonHighestTime.getHours() - 12));
                }
            }
            const moonPositionAtHighest = SunCalc.getMoonPosition(moonHighestTime, lat, lon);
            const moonData = SunCalc.getMoonData(moonHighestTime, lat, lon);
            const moonIllumination = SunCalc.getMoonIllumination(moonHighestTime);
            const moonDistancePercentage = (moonData.distance / averageMoonDistance) * 100;
            const moonEmoji = getMoonPhaseEmoji(moonIllumination.phaseValue);
            const sunRiseTime = isIn(sunTimesLeft.sunriseEnd.value) ? sunTimesLeft.sunriseEnd.value : sunTimesRight.sunriseEnd.value;
            const sunSetTime = isIn(sunTimesLeft.sunsetStart.value) ? sunTimesLeft.sunsetStart.value : sunTimesRight.sunsetStart.value;
            const sunDawnTime = isIn(sunTimesLeft.civilDawn.value) ? sunTimesLeft.civilDawn.value : sunTimesRight.civilDawn.value;
            const sunDuskTime = isIn(sunTimesLeft.civilDusk.value) ? sunTimesLeft.civilDusk.value : sunTimesRight.civilDusk.value;
            const sunNightTime = isIn(sunTimesLeft.astronomicalDusk.value) ? sunTimesLeft.astronomicalDusk.value : sunTimesRight.astronomicalDusk.value;
            const sunNightEndTime = isIn(sunTimesLeft.astronomicalDawn.value) ? sunTimesLeft.astronomicalDawn.value : sunTimesRight.astronomicalDawn.value;

            const getSunDarknessLevel = (time) => {
                const sunPosition = SunCalc.getPosition(time, lat, lon);
                const altitude = sunPosition.altitude * (180 / Math.PI);
                if (altitude < -18) return 'astronomicalNight';
                if (altitude < -12) return 'astronomicalTwilight';
                if (altitude < -6) return 'nauticalTwilight';
                if (altitude < 0) return 'civilTwilight';
                return 'day';
            };

            const getMoonIsVisible = (time) => {
                const moonPosition = SunCalc.getMoonPosition(time, lat, lon);
                const altitude = moonPosition.altitude * (180 / Math.PI);
                if (altitude < 0) return false;
                return true
            }

            const rowData = {
                startDate,
                endDate,
                moonRiseTime,
                moonSetTime,
                moonHighestTime,
                moonData,
                moonIllumination,
                moonRiseData,
                moonSetData,
                moonDistancePercentage,
                moonEmoji,
                sunRiseTime,
                sunSetTime,
                sunDawnTime,
                sunDuskTime,
                sunNightTime,
                sunNightEndTime,
                getSunDarknessLevel,
                getMoonIsVisible,
            }
            return rowData;
        };

        const getMoonSegmentColor = (isVisible, illumination) => {
            const c = Math.round(64 + (255 - 64) * illumination);
            return isVisible ? `rgba(${c}, ${c}, ${c}, 1)` : 'rgba(0, 0, 32, 0.8)';
        };

        const getWidth = (start, end) => `${(end - start) / (24 * 60 * 60 * 1000) * 100}%`;

        const createDarknessSegment = (start, end, level, rowData) => {
            const segment = document.createElement('div');
            segment.className = 'darkness-segment';
            segment.style.width = getWidth(start, end);
            segment.dataset.level = level;
            if (level === 'astronomicalNight') {
                const startElement = document.createElement('div');
                startElement.className = 'inline-indicator';
                if (start > rowData.startDate) {
                    startElement.textContent = formatDate(rowData.sunNightTime, 'HH:mm');
                }
                segment.appendChild(startElement);

                const endElement = document.createElement('div');
                endElement.className = 'inline-indicator';
                if (end < rowData.endDate) {
                    endElement.textContent = formatDate(rowData.sunNightEndTime, 'HH:mm');
                }
                segment.appendChild(endElement);
            }
            return segment;
        };

        const createMoonSegment = (start, end, isVisible, rowData) => {
            const segment = document.createElement('div');
            segment.className = 'moon-segment';
            segment.style.width = getWidth(start, end);
            segment.style.backgroundColor = getMoonSegmentColor(isVisible, rowData.moonIllumination.fraction);

            if (!isVisible) {
                const startElement = document.createElement('div');
                startElement.className = 'inline-indicator';
                if (start > rowData.startDate) {
                    startElement.textContent = formatDate(rowData.moonSetTime, 'HH:mm');
                }
                segment.appendChild(startElement);

                const endElement = document.createElement('div');
                endElement.className = 'inline-indicator';
                if (end < rowData.endDate) {
                    endElement.textContent = formatDate(rowData.moonRiseTime, 'HH:mm');
                }
                segment.appendChild(endElement);
            }

            return segment;
        };

        const createHourLabels = () => {
            const hourLabelsRow = document.createElement('div');
            hourLabelsRow.className = 'hour-labels-row';

            const emptyLeft = document.createElement('div');
            emptyLeft.className = 'day-left';
            emptyLeft.style.visibility = 'hidden';
            hourLabelsRow.appendChild(emptyLeft);

            const labelsContainer = document.createElement('div');
            labelsContainer.className = 'hour-labels-container';

            for (let hour = 12; hour <= 36; hour++) {
                const label = document.createElement('div');
                label.className = 'hour-label';
                label.textContent = `${(hour % 24).toString().padStart(2, '0')}:00`;
                label.style.left = `${((hour - 12) / 24) * 100}%`;
                labelsContainer.appendChild(label);
            }

            hourLabelsRow.appendChild(labelsContainer);

            const emptyRight = document.createElement('div');
            emptyRight.className = 'day-right';
            emptyRight.style.visibility = 'hidden';
            hourLabelsRow.appendChild(emptyRight);

            return hourLabelsRow;
        };

        const createDarknessBar = (rowData) => {
            const bar = document.createElement('div');
            bar.className = 'bar darkness-bar';

            let currentTime = new Date(rowData.startDate);
            let currentState = rowData.getSunDarknessLevel(currentTime);
            let segmentStart = new Date(currentTime);

            while (currentTime < rowData.endDate) {
                const newState = rowData.getSunDarknessLevel(currentTime);

                if (newState !== currentState) {
                    bar.appendChild(createDarknessSegment(segmentStart, currentTime, currentState, rowData));
                    segmentStart = new Date(currentTime);
                    currentState = newState;
                }
                currentTime.setMinutes(currentTime.getMinutes() + 5);
            }

            bar.appendChild(createDarknessSegment(segmentStart, rowData.endDate, currentState, rowData));

            return bar;
        };

        const createMoonBar = (rowData) => {
            const bar = document.createElement('div');
            bar.className = 'bar moon-bar';

            let currentTime = new Date(rowData.startDate);
            let currentState = rowData.getMoonIsVisible(currentTime);
            let segmentStart = new Date(currentTime);

            while (currentTime < rowData.endDate) {
                const newState = rowData.getMoonIsVisible(currentTime);

                if (newState !== currentState) {
                    bar.appendChild(createMoonSegment(segmentStart, currentTime, currentState, rowData));
                    segmentStart = new Date(currentTime);
                    currentState = newState;
                }
                currentTime.setMinutes(currentTime.getMinutes() + 5);
            }

            bar.appendChild(createMoonSegment(segmentStart, rowData.endDate, currentState, rowData));

            return bar;
        };

        const createOverlapBar = (rowData) => {
            const bar = document.createElement('div');
            bar.className = 'bar overlap-bar';

            let currentTime = new Date(rowData.startDate);
            let segmentStart = null;

            while (currentTime < rowData.endDate) {
                const isDark = rowData.getSunDarknessLevel(currentTime) === 'astronomicalNight';
                const isMoonInvisible = !rowData.getMoonIsVisible(currentTime);

                if (isDark && isMoonInvisible) {
                    if (!segmentStart) {
                        segmentStart = new Date(currentTime);
                    }
                } else if (segmentStart) {
                    const segment = document.createElement('div');
                    segment.className = 'overlap-segment';
                    segment.style.left = getWidth(rowData.startDate, segmentStart);
                    segment.style.width = getWidth(segmentStart, currentTime);
                    bar.appendChild(segment);
                    segmentStart = null;
                }

                currentTime.setMinutes(currentTime.getMinutes() + 5);
            }

            if (segmentStart) {
                const segment = document.createElement('div');
                segment.className = 'overlap-segment';
                segment.style.left = getWidth(rowData.startDate, segmentStart);
                segment.style.width = getWidth(segmentStart, rowData.endDate);
                bar.appendChild(segment);
            }

            return bar;
        };

        const getCompassDirection = (azimuthDegrees) => {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(azimuthDegrees / 22.5) % 16;
            return directions[index];
        };

        const createDetailSection = (rowData) => {
            const detailSection = document.createElement('div');
            detailSection.className = 'day-detail';
            detailSection.innerHTML = `
                <h3>Night Details ${formatDate(rowData.startDate, 'YYYY-MM-DD')} - ${formatDate(rowData.endDate, 'YYYY-MM-DD')}</h3>
                
                <h4>Darkness Information</h4>
                <table class="detail-table">
                    <tr>
                        <th>Level</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Duration</th>
                    </tr>
                    <tr>
                        <td>Civil Darkness</td>
                        <td>${formatDate(rowData.sunSetTime, 'HH:mm:ss')}</td>
                        <td>${formatDate(rowData.sunRiseTime, 'HH:mm:ss')}</td>
                        <td>${formatDuration(rowData.sunSetTime, rowData.sunRiseTime)}</td>
                    </tr>
                    <tr>
                        <td>Nautical Darkness</td>
                        <td>${formatDate(rowData.sunDuskTime, 'HH:mm:ss')}</td>
                        <td>${formatDate(rowData.sunDawnTime, 'HH:mm:ss')}</td>
                        <td>${formatDuration(rowData.sunDuskTime, rowData.sunDawnTime)}</td>
                    </tr>
                    <tr>
                        <td>Astronomical Darkness</td>
                        <td>${formatDate(rowData.sunNightTime, 'HH:mm:ss')}</td>
                        <td>${formatDate(rowData.sunNightEndTime, 'HH:mm:ss')}</td>
                        <td>${formatDuration(rowData.sunNightTime, rowData.sunNightEndTime)}</td>
                    </tr>
                </table>
                
                <h4>Moon Information</h4>
                <table class="detail-table">
                    <tr>
                        <td>Moon Phase</td>
                        <td>${rowData.moonIllumination.phase.name} (${(rowData.moonIllumination.fraction * 100).toFixed(1)}% illuminated)</td>
                    </tr>
                    <tr>
                        <td>Moonrise</td>
                        <td>${rowData.moonRiseTime ? formatDate(rowData.moonRiseTime, 'HH:mm:ss') : 'N/A'} (Azimuth ${rowData.moonRiseData.azimuthDegrees.toFixed(1)}Â° ${getCompassDirection(rowData.moonRiseData.azimuthDegrees)})</td>
                    </tr>
                    <tr>
                        <td>Moon Highest</td>
                        <td>${rowData.moonHighestTime ? formatDate(rowData.moonHighestTime, 'HH:mm:ss') : 'N/A'} (Azimuth ${rowData.moonData.azimuthDegrees.toFixed(1)}Â° ${getCompassDirection(rowData.moonData.azimuthDegrees)}, Altitude ${rowData.moonData.altitudeDegrees.toFixed(1)}Â°)</td>
                    </tr>
                    <tr>
                        <td>Moonset</td>
                        <td>${rowData.moonSetTime ? formatDate(rowData.moonSetTime, 'HH:mm:ss') : 'N/A'} (Azimuth ${rowData.moonSetData.azimuthDegrees.toFixed(1)}Â° ${getCompassDirection(rowData.moonSetData.azimuthDegrees)})</td>
                    </tr>
                    <tr>
                        <td>Moon Distance</td>
                        <td>${rowData.moonData.distance.toFixed(0)} km (${rowData.moonDistancePercentage.toFixed(2)}% of average)</td>
                    </tr>
                    <tr>
                        <td>Moon Parallactic Angle</td>
                        <td>${rowData.moonData.parallacticAngleDegrees.toFixed(1)}Â°</td>
                    </tr>
                    <tr>
                        <td>Moon Illumination Angle</td>
                        <td>${rowData.moonData.illumination.angle.toFixed(1)}Â°</td>
                    </tr>
                </table>
            `;
            return detailSection;
        };

        const createDayRow = (startDate, lat, lon) => {
            const rowData = getRowData(startDate, lat, lon);

            const dayRow = document.createElement('div');
            dayRow.className = 'day-row';

            const dayLeft = document.createElement('div');
            dayLeft.className = 'day-left';
            if ([5, 6].includes(rowData.startDate.getDay())) dayLeft.classList.add('weekend-night');
            
            dayLeft.innerHTML = `
                <div class="date-info">
                    <span>${formatDate(rowData.startDate, 'MMM D')}</span>
                    <span class="day-of-week">${formatDate(rowData.startDate, 'ddd')}</span>
                </div>
                <div class="moon-info">
                    <span class="moon-icon">${rowData.moonEmoji}</span>
                    <span>${(rowData.moonIllumination.fraction * 100).toFixed(0)}%</span>
                </div>
            `;
            dayRow.appendChild(dayLeft);

            const barsContainer = document.createElement('div');
            barsContainer.className = 'bars-container';

            barsContainer.appendChild(createDarknessBar(rowData));
            barsContainer.appendChild(createMoonBar(rowData));
            barsContainer.appendChild(createOverlapBar(rowData));
            for (let hour = 0; hour <= 24; hour++) {
                const line = document.createElement('div');
                line.className = 'hour-line';
                line.style.left = `${(hour / 24) * 100}%`;
                barsContainer.appendChild(line);
            }
            dayRow.appendChild(barsContainer);

            const dayRight = document.createElement('div');
            dayRight.className = 'day-right';
            if ([6, 0].includes(rowData.endDate.getDay())) dayRight.classList.add('weekend-night');
            dayRight.innerHTML = `
                <div class="date-info">
                    <span>${formatDate(rowData.endDate, 'MMM D')}</span>
                    <span class="day-of-week">${formatDate(rowData.endDate, 'ddd')}</span>
                </div>
            `;
            dayRow.appendChild(dayRight);

            const detailSection = createDetailSection(rowData);
            dayRow.appendChild(detailSection);

            dayRow.addEventListener('click', () => {
                detailSection.classList.toggle('active');
            });

            return dayRow;
        };

        const reverseGeocode = async (lat, lon) => {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.display_name;
            } catch (error) {
                console.error('Error reverse geocoding:', error);
                return null;
            }
        };

        const setCoordinates = async (lat, lon) => {
            $('#latitude').value = lat;
            $('#longitude').value = lon;
            setUrlParams(new URLSearchParams({ lat, lon }));

            const locationName = await reverseGeocode(lat, lon);
            if (locationName) {
                $('#location').value = locationName;
            }
        };

        const searchLocation = async (query) => {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error searching location:', error);
                alert('An error occurred while searching for the location. Please try again.');
                return [];
            }
        };

        const showLocationDropdown = (results) => {
            const dropdown = $('#location-dropdown');
            dropdown.innerHTML = '';
            dropdown.style.display = results.length ? 'block' : 'none';

            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = result.display_name;
                item.addEventListener('click', async () => {
                    dropdown.style.display = 'none';
                    await setCoordinates(result.lat, result.lon);
                    $('#location').value = result.display_name;
                    generateCalendar();
                });
                dropdown.appendChild(item);
            });
        };

        const useMyLocation = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude, longitude } = position.coords;
                    await setCoordinates(latitude, longitude);
                    generateCalendar();
                }, (error) => {
                    console.error('Error getting geolocation:', error);
                    alert('Unable to get your location. Please try entering coordinates manually.');
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        };

        const generateCalendar = async () => {
            const lat = parseFloat($('#latitude').value);
            const lon = parseFloat($('#longitude').value);
            const startDate = $('#start-date').value ? new Date($('#start-date').value) : new Date();
            const numDays = parseInt($('#num-days').value, 10);

            if (!lat || !lon || isNaN(startDate.getTime()) || isNaN(numDays) || numDays < 1) {
                alert('Please ensure location is set and all fields are filled correctly.');
                return;
            }

            const calendarView = $('#calendar-view');
            calendarView.innerHTML = '';
            calendarView.appendChild(createHourLabels());

            const start = new Date(startDate);
            start.setHours(12, 0, 0, 0);

            try {
                for (let day = 0; day < numDays; day++) {
                    const date = addDays(start, day);
                    const dayRow = createDayRow(date, lat, lon);
                    calendarView.appendChild(dayRow);
                }

                calendarView.appendChild(createHourLabels());
            } catch (error) {
                console.error('Error generating calendar:', error);
                alert('An error occurred while generating the calendar. Please try again.');
            }
        };

        const toggleInlineTimes = () => {
            document.body.classList.toggle('show-inline-times', $('#show-inline-times').checked);
        };

        const toggleHourLines = () => {
            document.body.classList.toggle('show-hour-lines', $('#show-hour-lines').checked);
        };

        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func(...args), delay);
            };
        };

        const debouncedGenerateCalendar = debounce(generateCalendar, 300);

        document.addEventListener('DOMContentLoaded', async () => {
            const params = getUrlParams();
            const lat = params.get('lat');
            const lon = params.get('lon');

            if (lat && lon) {
                await setCoordinates(lat, lon);
                generateCalendar();
            }

            $('#start-date').value = new Date().toISOString().split('T')[0];
            $('#use-location').addEventListener('click', useMyLocation);
            $('#set-coordinates').addEventListener('click', async () => {
                await setCoordinates($('#latitude').value, $('#longitude').value);
                generateCalendar();
            });

            // Add event listeners for start date and number of days
            $('#start-date').addEventListener('change', debouncedGenerateCalendar);
            $('#num-days').addEventListener('input', debouncedGenerateCalendar);

            const debouncedSearch = debounce(async (query) => {
                if (query.length > 2) {
                    const results = await searchLocation(query);
                    showLocationDropdown(results);
                } else {
                    $('#location-dropdown').style.display = 'none';
                }
            }, 300);

            $('#location').addEventListener('input', (e) => {
                debouncedSearch(e.target.value);
            });

            $('#show-inline-times').addEventListener('change', toggleInlineTimes);
            $('#show-hour-lines').addEventListener('change', toggleHourLines);
        });
    </script>
</body>
</html>
